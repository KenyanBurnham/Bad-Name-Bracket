/**
Instructions:
1. Download the totally valid names file as a CSV
2. Go to https://www.convertcsv.com/csv-to-json.htm
3. Input the CSV file and ask for "CTV to JSON array"

let nameArray = [
  ["Vanilla Stout Porter",5],
  ["Brief",1],
  ["Samuel \"Bridges\" Porter",2],
  ["Martin House Porter",8],
  ["Cole Wehrle Porter",4],
  ["Ben N. Syder Porter",6],
  ["Kareem O'Weet Porter",2],
  ["Jed I. Knight Porter",4],
  ["Uwe Eurotrash Porter *sponsored by BGGCon*",13 ],
  ["Wayne Kerr Porter",0],
  ["Mae Denless Porter",1],
  ["Tylorine Carler Porter",8],
  ["Marina Quey Porter",2],
  ["Steve Irwin Porter",4],
  ["Taylor tha Creator Porter",3],
  ["Ashcan Porter",7],
  ["P.P. Hertz Porter",5],
  ["Gaunter O'Dimm Porter",1],
  ["Alotta Fagina Porter",2],
  ["Kenya Swallow Porter",8],
  ["Yuri Nate Porter",4],
  ["Charity Case Porter",6],
  ["Yuri Dopted Porter",8],
  ["Nugget",2],
  ["Formula Juan Porter",6],
  ["Port au Prince Porter",0],
  ["Baliin King Porter",7],
  ["Dwalin Bee Porter",3],
  ["Fudgecicle Mocha Porter",2],
  ["Guisseppe Tuscany Porter",4],
  ["Mae Patty Baldwin Ness Porter",3],
  ["Hey Porter",7],
  ["Harry Porter",9],
  ["Rafael Edward \"Ted\" Cruz Porter",2],
  ["Beto O Porter",10],
  ["Moe Lester Porter",1],
  ["Taks Credditte Porter",12],
  ["Brick \"Andy\" Mortar Porter",2],
  ["Brooke N. Rubbers Porter",6],
  ["Ivana Humpalotte Porter",2],
  ["Warner Horner McWhorter Porter",4],
  ["Monday September Nineteenth Porter",2],
  ["La-a (\"ladasha\") Porter",3],
  ["John Jacob Jingleheimer Schmidt Porter",7],
  ["Crystal Tits Porter",4],
  ["Ellis D. Porter",2],
  ["Little Sweetmeat Porter",6],
  ["Eaton Dariche Porter",4],
  ["Baby McBaby Face Porter",2],
  ["Bubba Porter",9],
  ["Boar Porter ",2],
  ["Porterhouse Steak Porter",9],
  ["Portland Patagonia Porter ",4],
  ["Torpor Porter",6],
  ["Twoler Porter",6],
  ["Papa Porter ",0],
  ["Eunuch Porter ",0],
  ["PeeWee Porter",11],
  ["P. Sherman, 42 Wallaby Way, Sydney, Porter ",2],
  ["Joseph Ray Porter",9],
  ["Brownie Shytles Porter",1],
  ["Johnny Sins Porter",9],
  ["Lil' Sweet Porter",2],
  ["Marijauna Jesus Porter",10]
];

Match 3
let nameArray = [
  ["Vanilla Stout Porter",7],
  ["Martin House Porter",12],
  ["Ben N. Syder Porter",10],
  ["Jed I. Knight Porter",6],
  ["Uwe Eurotrash Porter *sponsored by BGGCon*",18 ],
  ["Tylorine Carler Porter",9],
  ["Steve Irwin Porter",7],
  ["Ashcan Porter",10],
  ["P.P. Hertz Porter",6],
  ["Kenya Swallow Porter",13],
  ["Charity Case Porter",9],
  ["Yuri Dopted Porter",11],
  ["Formula Juan Porter",12],
  ["Baliin King Porter",7],
  ["Guisseppe Tuscany Porter",6],
  ["Hey Porter",11],
  ["Harry Porter",13],
  ["Beto O Porter",12],
  ["Taks Credditte Porter",16],
  ["Brooke N. Rubbers Porter",10],
  ["Warner Horner McWhorter Porter",9],
  ["John Jacob Jingleheimer Schmidt Porter",8],
  ["Crystal Tits Porter",8],
  ["Little Sweetmeat Porter",8],
  ["Bubba Porter",12],
  ["Porterhouse Steak Porter",12],
  ["Torpor Porter",9],
  ["Twoler Porter",9],
  ["PeeWee Porter",11],
  ["Joseph Ray Porter",15],
  ["Johnny Sins Porter",12],
  ["Marijauna Jesus Porter",13]
];

Round 4

let nameArray = [
  ["Martin House Porter",12],
  ["Ben N. Syder Porter",10],
  ["Uwe Eurotrash Porter *sponsored by BGGCon*",18 ],
  ["Ashcan Porter",10],
  ["Kenya Swallow Porter",13],
  ["Yuri Dopted Porter",11],
  ["Formula Juan Porter",12],
  ["Hey Porter",11],
  ["Harry Porter",13],
  ["Taks Credditte Porter",16],
  ["Warner Horner McWhorter Porter",9],
  ["Crystal Tits Porter",8],
  ["Little Sweetmeat Porter",8],
  ["Bubba Porter",12],
  ["Porterhouse Steak Porter",12],
  ["Torpor Porter",9],
  ["Twoler Porter",9],
  ["Joseph Ray Porter",15],
  ["Marijauna Jesus Porter",13]
];
**/

//Use this link to generate a
    let nameArray = [
      ["Martin House Porter",15],
      ["Uwe Eurotrash Porter *sponsored by BGGCon*",22 ],
      ["Kenya Swallow Porter",15],
      ["Yuri Dopted Porter",15],
      ["Formula Juan Porter",18],
      ["Challenger [Kenya vs. Yuri]",18],
      ["Taks Credditte Porter",19],
      ["Warner Horner McWhorter Porter",9],
      ["Little Sweetmeat Porter",12],
      ["Porterhouse Steak Porter",17],
      ["Torpor Porter",13],
      ["Joseph Ray Porter",19],
];

/**
For crystal tits, put her on a shirt
Victory for Little Sweetmeat over Crystal Tits Porter
It was a tossup between Torpor and Twoler Porter, but Torpor pulled ahead.
Kenya Swallow and Yuri Dopted are now tied
Formula Juan takes an absolute racing lead against Hey Porter
Joseph Ray Porter blew Marijauna Jesus Porter right out of the water

Pray for the fallen
Ben N. Syder
Twoler
Bubba


Loses
Vanilla Stout Porter
Jed I. Knight Porter
Tylorine Carler Porter
Steve Irwin Porter
P.P. Hertz Porter
Charity Case Porter
Baliin King Porter
Guisseppe Tuscany Porter
Beto O Porter
Brooke N. Rubbers Porter
John Jacob Jingleheimer Schmidt Porter
PeeWee Porter
Johnny Sins Porter

Baliin King Porter lost horribly, Formula Juan Porter is unstoppable
There was a narrow loss for Beto O Porter by just a single vote in the Totally Valid Names Bracket and around 3 thousand votes in the Texas primaries. It would seem art imitates life.
I think it's fair to say many of us wrote off Taks Creddite Porter this past Spring, but it looks like they are dominating the field.
John Jacob Jingleheimer too felt the burn when Warner Horter McWhorter took him down in the final quarter

Joseph Ray Porter swept PeeWee all across the floor, it was a certified PeeWee catastrophe.
And holy smokes! It looks like Marijauna Jesus takes a lead over Johnny Sins.
**/

/**
Vanilla Stout v. Martin House Porter
Ben N. Syder v. Jed I. Knight
Uwe v. Tylorine
Steve irwin v. Ashcan
P.P. hertz v. Kenya
Charity Case v. Yuri Dopted
Fomula Juan v. Baliin
Guiseppe v. Hey
Harry v. Beto
Taks Credditte v. Brooke
Warner v. John Jacob
Crystal tits v. Little Sweetmeat
Bubba v. Porterhouse
Torpor v. Twoler
Peewee v Joseph
Johnny v. Marijauna

**/



//============================================

let names = [];
let scores = [];

//this breaks the imported name and score array
for (var i = 0; i < nameArray.length; i++) {
    let dataPoint = nameArray[i];
    let nameData = nameArray[i][0];
    let scoreData = nameArray[i][1];
    console.log("Name: " + nameData + ", Score: " + scoreData);
    names.push(nameArray[i][0]);
    scores.push(nameArray[i][1]);
}
console.log(names);
console.log(scores);

    function init() {

      // Since 2.2 you can also author concise templates with method chaining instead of GraphObject.make
      // For details, see https://gojs.net/latest/intro/buildingObjects.html
      const $ = go.GraphObject.make;  // for conciseness in defining templates

      myDiagram =
        $(go.Diagram, "myDiagramDiv",  // create a Diagram for the DIV HTML element
          {
            "textEditingTool.starting": go.TextEditingTool.SingleClick,
            "textEditingTool.textValidation": isValidScore,
            layout: $(go.TreeLayout, { angle: 180 }),
            "undoManager.isEnabled": true
          });

      // validation function for editing text
      function isValidScore(textblock, oldstr, newstr) {
        if (newstr === "") return true;
        var num = parseInt(newstr, 10);
        return !isNaN(num) && num >= 0 && num < 1000;
      }

      // define a simple Node template
      myDiagram.nodeTemplate =
        $(go.Node, "Auto",
          { selectable: false },
          $(go.Shape, "Rectangle",
            { fill: '#8C8C8C', stroke: null },
            // Shape.fill is bound to Node.data.color
            new go.Binding("fill", "color")),
          $(go.Panel, "Table",
            $(go.RowColumnDefinition, { column: 0, separatorStroke: "black" }),
            $(go.RowColumnDefinition, { column: 1, separatorStroke: "black", background: "#BABABA" }),
            $(go.RowColumnDefinition, { row: 0, separatorStroke: "black" }),
            $(go.RowColumnDefinition, { row: 1, separatorStroke: "black" }),
            $(go.TextBlock, "",
              {
                row: 0,
                wrap: go.TextBlock.None, margin: 5, width: 200,
                isMultiline: false, textAlign: 'left',
                font: '10pt  Segoe UI,sans-serif', stroke: 'white'
              },
              new go.Binding("text", "player1").makeTwoWay()),
            $(go.TextBlock, "",
              {
                row: 1,
                wrap: go.TextBlock.None, margin: 5, width: 200,
                isMultiline: false, textAlign: 'left',
                font: '10pt  Segoe UI,sans-serif', stroke: 'white'
              },
              new go.Binding("text", "player2").makeTwoWay()),
            $(go.TextBlock, "",
              {
                column: 1, row: 0,
                wrap: go.TextBlock.None, margin: 2, width: 25,
                isMultiline: false, editable: false, textAlign: 'center',
                font: '10pt  Segoe UI,sans-serif', stroke: 'black'
              },
              new go.Binding("text", "score1").makeTwoWay()),
            $(go.TextBlock, "",
              {
                column: 1, row: 1,
                wrap: go.TextBlock.None, margin: 2, width: 25,
                isMultiline: false, editable: false, textAlign: 'center',
                font: '10pt  Segoe UI,sans-serif', stroke: 'black'
              },
              new go.Binding("text", "score2").makeTwoWay())
          )
        );

      // define the Link template
      myDiagram.linkTemplate =
        $(go.Link,
          {
            routing: go.Link.Orthogonal,
            selectable: false
          },
          $(go.Shape, { strokeWidth: 2, stroke: 'white' }));


      // Generates the original graph from an array of player names
      function createPairs(players) {
        if (players.length % 2 !== 0) players.push('(empty)');
        var startingGroups = players.length / 2;
        var currentLevel = Math.ceil(Math.log(startingGroups) / Math.log(2));
        var levelGroups = [];
        var currentLevel = Math.ceil(Math.log(startingGroups) / Math.log(2));
        for (var i = 0; i < startingGroups; i++) {
          levelGroups.push(currentLevel + '-' + i);
        }
        var totalGroups = [];
        makeLevel(levelGroups, currentLevel, totalGroups, players);
        return totalGroups;
      }

      function makeLevel(levelGroups, currentLevel, totalGroups, players) {
        currentLevel--;
        var len = levelGroups.length;
        var parentKeys = [];
        var parentNumber = 0;
        var p = '';
        for (var i = 0; i < len; i++) {
          if (parentNumber === 0) {
            p = currentLevel + '-' + parentKeys.length;
            parentKeys.push(p);
          }

          if (players !== null) {
            var p1 = players[i * 2];
            var p2 = players[(i * 2) + 1];
            totalGroups.push({
              key: levelGroups[i], parent: p, player1: p1, player2: p2, parentNumber: parentNumber
            });
          } else {
            totalGroups.push({ key: levelGroups[i], parent: p, parentNumber: parentNumber });
          }

          parentNumber++;
          if (parentNumber > 1) parentNumber = 0;
        }

        // after the first created level there are no player names
        if (currentLevel >= 0) makeLevel(parentKeys, currentLevel, totalGroups, null)
      }

      function makeModel(players) {
        var model = new go.TreeModel(createPairs(players));

        model.addChangedListener(e => {
          if (e.propertyName !== 'score1' && e.propertyName !== 'score2') return;
          var data = e.object;
          if (isNaN(data.score1) || isNaN(data.score2)) return;

          // TODO: What happens if score1 and score2 are the same number?

          // both score1 and score2 are numbers,
          // set the name of the higher-score'd player in the advancing (parent) node
          // if the data.parentNumber is 0, then we set player1 on the parent
          // if the data.parentNumber is 1, then we set player2
          var parent = myDiagram.findNodeForKey(data.parent);
          if (parent === null) return;

          var playerName = parseInt(data.score1) > parseInt(data.score2) ? data.player1 : data.player2;
          if (parseInt(data.score1) === parseInt(data.score2)) playerName = "";
          myDiagram.model.setDataProperty(parent.data, (data.parentNumber === 0 ? "player1" : "player2"), playerName);
        });

        myDiagram.model = model;

        console.log(model);
        // provide initial scores
        for (var i = 0; i < model.nodeDataArray.length; i++) {
          var d = model.nodeDataArray[i];
          if (d.player1 && d.player2) {
            let scoreOne = scores.shift();
            let scoreTwo = scores.shift();
            // TODO: doesn't prevent tie scores
            model.setDataProperty(d, "score1", scoreOne);
            model.setDataProperty(d, "score2", scoreTwo);
          }
        }

      }

      makeModel(names);
    } // end init
    window.addEventListener('DOMContentLoaded', init);
